<!DOCTYPE html>
<html>

    <head>
        <title></title>
        <meta charset="utf-8" />
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet"
            href="vendor/salesforce-lightning-design-system/styles/salesforce-lightning-design-system.css">
        <link rel="stylesheet" href="css/styles.css">
        <script type="text/javascript"
            src="//code.jquery.com/git/jquery-git.min.js"></script>
        <script type="text/javascript" src="js/require.js"></script>
        <script type="text/javascript">
        (function () {
            var config = {
                baseUrl: 'js'
            };

            var dependencies = [
                'customActivity'
            ];

            require(config, dependencies);
        })();
    </script>
    </head>

    <body>
        <div id="step1" class="step">
            <div class="slds-grid">

                <main class="slds-col slds-size--1-of-3
                    slds-p-horizontal--small">
                    <h1>Welcome to your activity!</h1>

                </main>



            </div>

        </div>
    </body>
    <script type="text/javascript">

        var journey = new JourneyBuilder();
        var dataExtensionExternalKey = "0AC6FA19-9623-482F-848F-C487F9CB3FCC";
    
        /**
         * main function to initialize the activity
         */
        function initActivity() {
            console.log("initActivity called");
    
            // call to get the auth token
            journey.trigger('requestTokens');
        }
    
        /**
         * function called when the auth token has been provided
         * @param tokens
         */
        function onTokens(tokens) {
            console.log("onTokens called");
    
            // call to get data extension details and data
            journey.trigger('requestEndpoints');
        }
    
        /**
         * function called when the data extension endpoint has been provided
         * @param endpoints
         */
        function onEndpoints(endpoints) {
            console.log("onEndpoints called");
    
            // use the endpoint to get data extension details
            var url = endpoints.rest + '/data/v1/customobjectdata/key/' + dataExtensionExternalKey;
    
            $.ajax({
                url: url,
                headers: {'Authorization': 'Bearer ' + endpoints.token},
                success: onDataLoad,
                error: onFailure
            });
        }
    
        /**
         * function called on successful data retrieval
         * @param response
         */
        function onDataLoad(response) {
            console.log("onDataLoad called");
    
            // get column names
            var columns = Object.keys(response.items[0]);
    
            // create HTML table
            var table = '<table>';
            table += '<thead><tr>';
            for (var i = 0; i < columns.length; i++) {
                table += '<th>' + columns[i] + '</th>';
            }
            table += '</tr></thead>';
            table += '<tbody>';
            for (var j = 0; j < response.items.length; j++) {
                table += '<tr>';
                for (var k = 0; k < columns.length; k++) {
                    table += '<td>' + response.items[j][columns[k]] + '</td>';
                }
                table += '</tr>';
            }
            table += '</tbody></table>';
    
            // display the HTML table
            $('#target').html(table);
    
            // update the user interface
            journey.trigger('updateButton', { button: 'next', enabled: true });
        }
    
        /**
         * function called on error during data retrieval
         * @param xhr
         * @param textStatus
         * @param errorThrown
         */
        function onFailure(xhr, textStatus, errorThrown) {
            console.log("onFailure called: " + errorThrown);
    
            // display error message on user interface
            $('#target').text('Error: ' + errorThrown);
    
            // update the user interface
            journey.trigger('updateButton', { button: 'next', enabled: false });
        }
    
        /**
         * function called when next button is clicked
         */
        function clickedNext() {
            console.log("clickedNext called");
    
            // call to update the journey
            journey.trigger('updateActivity', { data: {}, save: true });
        }
    
        // call initActivity on page load
        $(document).ready(function() {
            initActivity();
        });
    
    </script>
</html>
